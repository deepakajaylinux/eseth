
<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8">

        

        <title>Nethack Zsh Prompt</title>

        
        <link rel="stylesheet" href="../_static/base-eseth.css" type="text/css" />
        
        <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
        

        
        <link rel="alternate" type="application/rss+xml" href="/rss.xml" title="RSS 2.0">
        

        <script type="text/javascript">
            var DOCUMENTATION_OPTIONS = {
                URL_ROOT:    '../',
                VERSION:     '1.0',
                COLLAPSE_MODINDEX: false,
                FILE_SUFFIX: '.html',
                HAS_SOURCE:  true
            };
        </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../_static/favicon.ico"/>
            <link rel="top" title="Esoteric Rubbish" href="../index.html" />
            <link rel="up" title="2009" href="index.html" />
            <link rel="next" title="2010" href="../2010/index.html" />
            <link rel="prev" title="2009" href="index.html" />
        <link rel="stylesheet" href="../_static/jquery.github_badge.css?v=1" />
        <script src="../_static/jquery.github_badge.js"></script>
        <script>
            jQuery(document).ready(function($){
                $('#github-badge').GithubBadge({
                    login: 'whiteinge',
                    image_path: '../_static/images/'
                });
            });
        </script>
        
    </head>

    <body>
        <div class="documentwrapper"><div class="bodywrapper">
<div class="related">
    <h3>Navigation</h3>
    <ul>
        <li class="right" style="margin-right: 10px">
        <a href="../genindex.html" title="General Index"
            accesskey="I">index</a></li>
        <li class="right" >
        <a href="../2010/index.html" title="2010"
            accesskey="N">next</a> |</li>
        <li class="right" >
        <a href="index.html" title="2009"
            accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Esoteric Rubbish</a> &raquo;</li>
        <li><a href="index.html" accesskey="U">2009</a> &raquo;</li>
    </ul>
</div>

            <div class="body">
                
  <div class="section" id="nethack-zsh-prompt">
<span id="post-nethack-term"></span><h1>Nethack Zsh Prompt</h1>
<p class="rubric">Easy multi-line prompts using Zsh arrays</p>
<div class="contents local topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id1">Overview</a></li>
<li><a class="reference internal" href="#building-the-prompt" id="id2">Building the prompt</a><ul>
<li><a class="reference internal" href="#color-aliases" id="id3">Color aliases</a></li>
<li><a class="reference internal" href="#the-top-line" id="id4">The top line</a></li>
<li><a class="reference internal" href="#the-remaining-lines" id="id5">The remaining lines</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conclusion" id="id6">Conclusion</a></li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id1">Overview</a></h2>
<p>This is a quick overview of my two- (sometimes three-) line Zsh prompt. It is
built using Zsh arrays which makes the code extremely readable and mantainable.
Each line of the prompt is an element in an array.</p>
<p><a class="reference external" href="http://github.com/whiteinge/dotfiles/blob/master/.zsh_shouse_prompt">The code can be found on GitHub.</a></p>
<p>In addition, I wanted the faithful dog from NetHack to wander around my prompt
as I work. If you have ever played NetHack then you know how useful a good pet
can be. Well, this helpfulness also extends to marathon coding sessions.</p>
<img alt="../_images/nethack-term.png" src="../_images/nethack-term.png" />
<p>Other than that the prompt should strive to be as minimalist as possible while
still providing a wealth of information, as needed:</p>
<ol class="arabic simple">
<li>The prompt changes to red when the last command exited badly.</li>
<li>The current working directory changes to yellow if it isn’t writable.</li>
<li>The number of jobs show up, when there are any.</li>
<li>The hostname only shows up when you’re SSH-ed into another system.</li>
</ol>
</div>
<div class="section" id="building-the-prompt">
<h2><a class="toc-backref" href="#id2">Building the prompt</a></h2>
<p>A step by step walkthrough. Be sure to have the following Zsh manpages handy.</p>
<dl class="docutils">
<dt><em class="manpage">zshexpn(1)</em></dt>
<dd>Look up expansions in the section titled “PARAMETER EXPANSION”. For
example, <tt class="docutils literal"><span class="pre">${(j:</span> <span class="pre">:)somearray}</span></tt> to join the elements of an array into a
string.</dd>
<dt><em class="manpage">zshmisc(1)</em></dt>
<dd>Look up escapes that you can use in your prompt in the section titled
“SIMPLE PROMPT ESCAPES”.</dd>
<dt><em class="manpage">zshparam(1)</em></dt>
<dd>Read about arrays in Zsh in the section titled “ARRAY PARAMETERS”.</dd>
<dt><em class="manpage">zshmodules(1)</em></dt>
<dd>Read the syntax on how to use <tt class="docutils literal"><span class="pre">zstyle</span></tt>.</dd>
</dl>
<div class="section" id="color-aliases">
<h3><a class="toc-backref" href="#id3">Color aliases</a></h3>
<p>To keep things short lets make some aliases for the colors we intend to use.
(This will also help later when we strip all the color out of the prompt to
determine how wide it is.) As per the <a class="reference external" href="http://zshwiki.org/home/config/prompt">recommendation for prompts</a> on the Zsh
wiki, we’re wrapping all our colors with <tt class="docutils literal"><span class="pre">%{..%}</span></tt>:</p>
<div class="highlight-python"><pre>autoload -U colors &amp;&amp; colors
local reset white gray green red

reset="%{${reset_color}%}"
white="%{$fg[white]%}"
gray="%{$fg_bold[black]%}"
green="%{$fg_bold[green]%}"
red="%{$fg[red]%}"
yellow="%{$fg[yellow]%}"</pre>
</div>
</div>
<div class="section" id="the-top-line">
<h3><a class="toc-backref" href="#id4">The top line</a></h3>
<p>We’re going to store the elements that make up the top line in an array for
now. The top line is the most complicated line of our prompt and that will be
useful when determining how much padding we need for the full-width padding:</p>
<div class="highlight-python"><pre>local -a infoline</pre>
</div>
<p>Add an element to the array containing a color escape based on if the current
directory is writable:</p>
<div class="highlight-python"><pre>[[ -w $PWD ]] &amp;&amp; infoline+=( ${green} ) || infoline+=( ${yellow} )</pre>
</div>
<p>Add the escape to show the current directory &amp; path and reset the color:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">infoline</span><span class="o">+=</span><span class="p">(</span> <span class="s">&quot;%~ &quot;</span> <span class="p">)</span>
<span class="n">infoline</span><span class="o">+=</span><span class="p">(</span> <span class="s">&quot;${reset} &quot;</span> <span class="p">)</span>
</pre></div>
</div>
<p>Now add the current username:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">infoline</span><span class="o">+=</span><span class="p">(</span> <span class="s">&quot;%n&quot;</span> <span class="p">)</span>
</pre></div>
</div>
<p>If we’re ssh-ed into a machine, add the hostname:</p>
<div class="highlight-python"><pre>[[ -n $SSH_CLIENT ]] &amp;&amp; infoline+=( "@%m" )</pre>
</div>
<p>We want the top line to run the full width of the terminal so we need to take
the width of the terminal window and subtract the width of all the characters
we have assembled so far. Unfortunately this can be a little tricky because
color escapes count as non-zero width.</p>
<p>Since all our colors are already wrapped with <tt class="docutils literal"><span class="pre">%{..%}</span></tt> the easiest way to
pull out the color is to do a simple search and replace for that wrapper. (The
<tt class="docutils literal"><span class="pre">(S)</span></tt> tells it to search substrings.):</p>
<div class="highlight-python"><pre>local i_width

i_width=${(S)infoline//\%\{*\%\}}</pre>
</div>
<p>Great, all the color is gone. We need to expand all the escapes so that <tt class="docutils literal"><span class="pre">%~</span></tt>
gets expanded into <tt class="docutils literal"><span class="pre">~/Pictures/lolcats/Superheroes</span></tt> (for example) and <tt class="docutils literal"><span class="pre">%n</span></tt>
gets expanded to <tt class="docutils literal"><span class="pre">shouse</span></tt>. While we’re at it, lets also count how many
characters are in the string:</p>
<div class="highlight-python"><pre>i_width=${#${(%)i_width}}</pre>
</div>
<p><span class="target" id="index-0"></span><tt class="xref std std-envvar docutils literal"><span class="pre">$COLUMNS</span></tt> is automatically set to the width of the terminal window;
finally, we can find the difference of the two variables and see how much
filler we’re going to need:</p>
<div class="highlight-python"><pre>local i_filler

i_filler=$(( $COLUMNS - $i_width ))</pre>
</div>
<p>Then we can generate that filler; in this case we’re generating <tt class="docutils literal"><span class="pre">.</span></tt>
characters with Zsh’s padding expansion:</p>
<div class="highlight-python"><pre>local filler

filler="${gray}${(l:${i_filler}::.:)}${reset}"</pre>
</div>
<p>Last we need to insert the filler into our array in the position we want. In
this case we want it right in-between the <tt class="docutils literal"><span class="pre">%~</span></tt> and the <tt class="docutils literal"><span class="pre">%n</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">infoline</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="p">(</span> <span class="s">&quot;${infoline[2]} ${filler} &quot;</span> <span class="p">)</span>
</pre></div>
</div>
<p>Our top line is complete.</p>
</div>
<div class="section" id="the-remaining-lines">
<h3><a class="toc-backref" href="#id5">The remaining lines</a></h3>
<p>The top line is the hard one since it’s full-width. We’re almost done. We still
need the actual prompt line and we also want a third line to display
version-control status when we’re in a Git/Mercurial/et al repository.</p>
<p>Lets create a new array to hold each line in our prompt and add our top line as
a string:</p>
<div class="highlight-python"><pre>local -a lines

lines+=( ${(j::)infoline} )</pre>
</div>
<p>Zsh has an awesome contrib module for pulling information from VCS repositories
called <tt class="docutils literal"><span class="pre">vcs_info</span></tt>. You can read about it in <em class="manpage">zshcontrib(1)</em>.</p>
<div class="admonition-see-also admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="../2010/git-in-zsh.html#post-git-in-zsh"><em>Git Info in Your Zsh Prompt</em></a></p>
</div>
<div class="admonition-see-also admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="../2010/hg-in-zsh.html#post-hg-in-zsh"><em>Mercurial Info in Your Zsh Prompt</em></a></p>
</div>
<p>When it detects that we are inside some VCS repository it fills the variable
<tt class="docutils literal"><span class="pre">$vcs_info_msg_0_</span></tt> so lets add that variable to our array only if it contains
information:</p>
<div class="highlight-python"><pre>[[ -n ${vcs_info_msg_0_} ]] &amp;&amp; lines+=( "${gray}${vcs_info_msg_0_}${reset}" )</pre>
</div>
<p>Now lets add the final line that contains the actual prompt:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">lines</span><span class="o">+=</span><span class="p">(</span> <span class="s">&quot;%(1j.${gray}%j${reset} .)%(0?.${white}.${red})%#${reset} &quot;</span> <span class="p">)</span>
</pre></div>
</div>
<p>Last, but not least, lets join all the array elements together in a string
separating them with newlines:</p>
<div class="highlight-python"><pre>PROMPT=${(F)lines}</pre>
</div>
<p>That’s it! Pretty easy, huh?</p>
</div>
</div>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#id6">Conclusion</a></h2>
<p>All together, the code looks like this:</p>
<div class="highlight-python"><pre>function setprompt() {
    local -a lines infoline
    local x i pet dungeon filler i_width i_pad

    # A domestic animal, the _tame dog_ (_Canis familiaris_)
    pet=d

    ### First, assemble the top line
    # Current dir; show in yellow if not writable
    [[ -w $PWD ]] &amp;&amp; infoline+=( ${green} ) || infoline+=( ${yellow} )
    infoline+=( "%~${reset} " )

    # Username &amp; host
    infoline+=( "%n" )
    [[ -n $SSH_CLIENT ]] &amp;&amp; infoline+=( "@%m" )

    # Strip color to find text width &amp; make the full-width filler
    zstyle -T ":pr-nethack:" show-pet &amp;&amp; i_pad=4 || i_pad=0

    i_width=${(S)infoline//\%\{*\%\}} # search-and-replace color escapes
    i_width=${#${(%)i_width}} # expand all escapes and count the chars

    filler="${gray}${(l:$(( $COLUMNS - $i_width - $i_pad ))::.:)}${reset}"
    infoline[2]=( "${infoline[2]} ${filler} " )

    ### Now, assemble all prompt lines
    lines+=( ${(j::)infoline} )
    [[ -n ${vcs_info_msg_0_} ]] &amp;&amp; lines+=( "${gray}${vcs_info_msg_0_}${reset}" )
    lines+=( "%(1j.${gray}%j${reset} .)%(0?.${white}.${red})%#${reset} " )

    ### Add dungeon floor to each line
    # Allow easy toggling of pet display
    if zstyle -T ":pr-nethack:" show-pet ; then
        dungeon=${(l:$(( ${#lines} * 3 ))::.:)}
        dungeon[$[${RANDOM}%${#dungeon}]+1]=$pet

        for (( i=1; i &lt; $(( ${#lines} + 1 )); i++ )) ; do
            case $i in
                1) x=1;; 2) x=4;; 3) x=7;; 4) x=10;;
            esac
            lines[$i]="${gray}${dungeon[x,$(( $x + 2 ))]} ${lines[$i]}${reset}"
        done
    fi

    ### Finally, set the prompt
    PROMPT=${(F)lines}
}

function precmd {
    vcs_info
    setprompt
}</pre>
</div>
</div>
</div>



                
                <div class="summary">
                    <p>Posted 1224 days ago on 2009-12-22.</p>
                </div>
                

                
        </div></div>
        <div id="disqus_thread" class="body comments"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'esotericrubbish'; // required: replace example with your forum shortname

            // The following are highly recommended additional parameters. Remove the slashes in front to use.
            // var disqus_identifier = 'unique_dynamic_id_1234';
            // var disqus_url = 'http://example.com/permalink-to-page.html';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="related">
    <h3>Navigation</h3>
    <ul>
        <li class="right" style="margin-right: 10px">
        <a href="../genindex.html" title="General Index"
            >index</a></li>
        <li class="right" >
        <a href="../2010/index.html" title="2010"
            >next</a> |</li>
        <li class="right" >
        <a href="index.html" title="2009"
            >previous</a> |</li>
        <li><a href="../index.html">Esoteric Rubbish</a> &raquo;</li>
        <li><a href="index.html" >2009</a> &raquo;</li>
    </ul>
</div>
            <div class="footer">
                &copy; <a href="http://google.com/profiles/whiteinge" rel="me">Copyright 2009, Seth House</a>.

                <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/us/">Some rights reserved</a>.
                Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
            </div>

            <script type="text/javascript">
                var _gaq = _gaq || [];
                _gaq.push(['_setAccount', 'UA-12716924-1']);
                _gaq.push(['_trackPageview']);

                (function() {
                    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();
            </script>
    </body>
</html>