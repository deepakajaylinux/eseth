
<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8">

        

        <title>Setting project-level grep options</title>

        
        <link rel="stylesheet" href="../_static/base-eseth.css" type="text/css" />
        
        <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
        

        
        <link rel="alternate" type="application/rss+xml" href="/rss.xml" title="RSS 2.0">
        

        <script type="text/javascript">
            var DOCUMENTATION_OPTIONS = {
                URL_ROOT:    '../',
                VERSION:     '1.0',
                COLLAPSE_MODINDEX: false,
                FILE_SUFFIX: '.html',
                HAS_SOURCE:  true
            };
        </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../_static/favicon.ico"/>
            <link rel="top" title="Esoteric Rubbish" href="../index.html" />
            <link rel="up" title="2013" href="index.html" />
            <link rel="prev" title="2013" href="index.html" />
        <link rel="stylesheet" href="../_static/jquery.github_badge.css?v=1" />
        <script src="../_static/jquery.github_badge.js"></script>
        <script>
            jQuery(document).ready(function($){
                $('#github-badge').GithubBadge({
                    login: 'whiteinge',
                    image_path: '../_static/images/'
                });
            });
        </script>
        
    </head>

    <body>
        <div class="documentwrapper"><div class="bodywrapper">
<div class="related">
    <h3>Navigation</h3>
    <ul>
        <li class="right" style="margin-right: 10px">
        <a href="../genindex.html" title="General Index"
            accesskey="I">index</a></li>
        <li class="right" >
        <a href="index.html" title="2013"
            accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Esoteric Rubbish</a> &raquo;</li>
        <li><a href="index.html" accesskey="U">2013</a> &raquo;</li>
    </ul>
</div>

            <div class="body">
                
  <div class="section" id="setting-project-level-grep-options">
<span id="post-project-grepignore"></span><h1>Setting project-level <strong class="command">grep</strong> options</h1>
<p class="rubric">Using Zsh&#8217;s <tt class="docutils literal"><span class="pre">precmd</span></tt></p>
<div class="contents local topic" id="contents">
<span id="index-0"></span><p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#grep-options" id="id3"><tt class="xref std std-envvar docutils literal"><span class="pre">GREP_OPTIONS</span></tt></a></li>
<li><a class="reference internal" href="#dynamically-setting-environment-variables" id="id4">Dynamically setting environment variables</a></li>
<li><a class="reference internal" href="#reading-files-into-zsh-arrays" id="id5">Reading files into Zsh arrays</a></li>
<li><a class="reference internal" href="#add-new-values-to-an-array" id="id6">Add new values to an array</a></li>
<li><a class="reference internal" href="#summary" id="id7">Summary</a></li>
</ul>
</div>
<p>The venerable <strong class="command">grep</strong> has not aged terribly well giving rise to (the
admitedly cool) <a class="reference external" href="http://beyondgrep.com/">Ack</a>. One handy feature of Ack is being able to set options
specifically for a single project by placing a dotfile in the project
directory. This is easily mimicked for <strong class="command">grep</strong> using a handy Zsh
feature. (This is also possible in Bash, of course, with a bit more code.)</p>
<div class="section" id="grep-options">
<h2><a class="toc-backref" href="#id3"><span class="target" id="index-1"></span><tt class="xref std std-envvar docutils literal"><span class="pre">GREP_OPTIONS</span></tt></a></h2>
<p>You can set default options for <strong class="command">grep</strong> in an environment variable
named <span class="target" id="index-2"></span><tt class="xref std std-envvar docutils literal"><span class="pre">GREP_OPTIONS</span></tt>. For example a nice default to put in your
<tt class="docutils literal"><span class="pre">.zshrc</span></tt> file is:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">GREP_OPTIONS</span><span class="o">=</span><span class="s2">&quot;--color --exclude-dir=.svn --exclude-dir=.hg --exclude-dir=.git&quot;</span>
<span class="nb">export </span>GREP_OPTIONS
</pre></div>
</div>
</div>
<div class="section" id="dynamically-setting-environment-variables">
<h2><a class="toc-backref" href="#id4">Dynamically setting environment variables</a></h2>
<p>Zsh has a handy feature called <a class="reference external" href="http://zsh.sourceforge.net/Doc/Release/Functions.html">precmd</a> which is a function that you define
in your <tt class="docutils literal"><span class="pre">~/.zshrc</span></tt> file that is run before each time your prompt is drawn to
the screen. In fact you can have several such functions if you put them in an
array:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">local</span> -a precmd_functions

<span class="k">function </span>grep_options<span class="o">()</span> <span class="o">{</span>
    <span class="nv">GREP_OPTIONS</span><span class="o">=</span><span class="s2">&quot;--color --exclude-dir=.svn --exclude-dir=.hg --exclude-dir=.git&quot;</span>
    <span class="nb">export </span>GREP_OPTIONS
<span class="o">}</span>

<span class="nv">precmd_functions</span><span class="o">=(</span> grep_options <span class="o">)</span>
</pre></div>
</div>
<p>See where this is going?  :)</p>
</div>
<div class="section" id="reading-files-into-zsh-arrays">
<h2><a class="toc-backref" href="#id5">Reading files into Zsh arrays</a></h2>
<p>First-class support for arrays in one thing (of many) that really sets Zsh
apart from Bash. Zsh has many internal functions for working with arrays and
many internal functions that work with arrays as parameters. (No need for
Bash&#8217;s <tt class="docutils literal"><span class="pre">IFS</span></tt> bullshit.) You can see many such functions by referencing the
following two Zsh manpages:</p>
<ul class="simple">
<li><em class="manpage">zshexpn(1)</em> under &#8220;PARAMETER EXPANSION&#8221;</li>
<li><em class="manpage">zshparam(1)</em> under &#8220;ARRAY PARAMETERS&#8221;</li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">(f)</span></tt> parameter referenced in <em class="manpage">zshparam(1)</em> reads
newline-separated records as values into an array. Another, <tt class="docutils literal"><span class="pre">$(&lt;)</span></tt> reads the
contents of a file into a variable. Combined you have a one-liner that reads
each line of a file into an array:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">local</span> -a opts
<span class="nv">opts</span><span class="o">=(</span> <span class="k">${</span><span class="p">(f)</span><span class="s2">&quot;$(&lt; ${HOME}/.grepoptions)&quot;</span><span class="k">}</span> <span class="o">)</span>
</pre></div>
</div>
<p>Neat. What if you want to add comments to that file too? Obviously, they
shouldn&#8217;t be included in the array. You can see in <em class="manpage">zshexpn(1)</em> that
many of the substitutions that work on strings also work on individual array
items if given an array. The <tt class="docutils literal"><span class="pre">${name:#pattern}</span></tt> substitution will remove
items from an array that match a pattern. A comment character followed by
anything looks like <tt class="docutils literal"><span class="pre">[#]*</span></tt>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">local</span> -a opts
<span class="nv">opts</span><span class="o">=(</span> <span class="k">${${</span><span class="p">(f)</span><span class="s2">&quot;$(&lt; ${HOME}/.grepoptions)&quot;</span><span class="k">}</span><span class="p">:#[#]*</span><span class="k">}</span> <span class="o">)</span>
</pre></div>
</div>
<p>Create a file in your home directory named <tt class="docutils literal"><span class="pre">.grepoptions</span></tt> to hold the options
you always want passed to <strong class="command">grep</strong> and each line will be added to the
array:</p>
<div class="highlight-bash"><div class="highlight"><pre>--color
--exclude-dir<span class="o">=</span>.svn
--exclude-dir<span class="o">=</span>.hg
--exclude-dir<span class="o">=</span>.git
</pre></div>
</div>
</div>
<div class="section" id="add-new-values-to-an-array">
<h2><a class="toc-backref" href="#id6">Add new values to an array</a></h2>
<p>Next modify your shell function to also look for a <tt class="docutils literal"><span class="pre">.grepoptions</span></tt> file in the
current directory so its contents can be added to the array (note the <tt class="docutils literal"><span class="pre">+=</span></tt>):</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">local </span><span class="nv">proj_opts</span><span class="o">=</span><span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>/.grepoptions

<span class="k">if</span> <span class="o">[[</span> -r <span class="k">${</span><span class="nv">proj_opts</span><span class="k">}</span> <span class="o">]]</span> ; <span class="k">then</span>
<span class="k">    </span>opts+<span class="o">=(</span> <span class="k">${${</span><span class="p">(f)</span><span class="s2">&quot;$(&lt; &quot;</span><span class="k">${</span><span class="nv">proj_opts</span><span class="k">}</span><span class="s2">&quot;)&quot;</span><span class="k">}</span><span class="p">:#[#]*</span><span class="k">}</span> <span class="o">)</span>
<span class="k">fi</span>
</pre></div>
</div>
<p>Great. You now have an array containing the aggregate of two <tt class="docutils literal"><span class="pre">.grepoptions</span></tt>
files. The last step is to assemble the array back to a string so you can
export the <span class="target" id="index-3"></span><tt class="xref std std-envvar docutils literal"><span class="pre">GREP_OPTIONS</span></tt> environment variable. Zsh arrays have a join
parameter of the form <tt class="docutils literal"><span class="pre">${(j:</span> <span class="pre">:)name}</span></tt> where the character between the colons
is the character to join with.</p>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id7">Summary</a></h2>
<p>Putting everything together you should have something similar to the following
in your <tt class="docutils literal"><span class="pre">~/.zshrc</span></tt>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">local</span> -a precmd_functions

<span class="k">function </span>grep_options<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> -a opts
    <span class="nb">local </span><span class="nv">proj_opts</span><span class="o">=</span><span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>/.grepoptions

    <span class="c"># Grab the global options</span>
    <span class="nv">opts</span><span class="o">=(</span> <span class="k">${</span><span class="p">(f)</span><span class="s2">&quot;$(&lt; &quot;</span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="p">/.grepoptions</span><span class="s2">&quot;)&quot;</span><span class="k">}</span> <span class="o">)</span>

    <span class="c"># Grab any project-local options</span>
    <span class="k">if</span> <span class="o">[[</span> -r <span class="k">${</span><span class="nv">proj_opts</span><span class="k">}</span> <span class="o">]]</span> ; <span class="k">then</span>
<span class="k">        </span>opts+<span class="o">=(</span> <span class="k">${${</span><span class="p">(f)</span><span class="s2">&quot;$(&lt; &quot;</span><span class="k">${</span><span class="nv">proj_opts</span><span class="k">}</span><span class="s2">&quot;)&quot;</span><span class="k">}</span><span class="p">:#[#]*</span><span class="k">}</span> <span class="o">)</span>
    <span class="k">fi</span>

    <span class="c"># Assemble and export</span>
    <span class="nv">GREP_OPTIONS</span><span class="o">=</span><span class="s2">&quot;${(j: :)opts}&quot;</span>
    <span class="nb">export </span>GREP_OPTIONS
<span class="o">}</span>

<span class="nv">precmd_functions</span><span class="o">=(</span> grep_options <span class="o">)</span>
</pre></div>
</div>
<p>Since this function is executed as a Zsh <tt class="docutils literal"><span class="pre">precmd</span></tt> the value of the
<span class="target" id="index-4"></span><tt class="xref std std-envvar docutils literal"><span class="pre">GREP_OPTIONS</span></tt> environment variable will change as you <strong class="command">cd</strong>
around the file system. If you have any other <tt class="docutils literal"><span class="pre">precmd</span></tt> functions simply add
them to the <tt class="docutils literal"><span class="pre">precmd_functions</span></tt> array to run them all.</p>
<p>Here is a example shell session:</p>
<div class="highlight-bash"><div class="highlight"><pre>~  % <span class="nb">cd</span> <span class="nv">$HOME</span>
~  % <span class="nb">echo</span> <span class="nv">$GREP_OPTIONS</span>
--color --exclude-dir<span class="o">=</span>.svn --exclude-dir<span class="o">=</span>.hg --exclude-dir<span class="o">=</span>.git
~  % <span class="nb">cd</span> ~/path/to/myproject
% cat .grepoptions
<span class="c"># Don&#39;t grep any minified JavaScript files</span>
--exclude<span class="o">=</span><span class="se">\*</span>min.js

<span class="c"># Don&#39;t grep third-party libs</span>
--exclude-dir<span class="o">=</span>lib
% <span class="nb">echo</span> <span class="nv">$GREP_OPTIONS</span>
--color --exclude-dir<span class="o">=</span>.svn --exclude-dir<span class="o">=</span>.hg --exclude-dir<span class="o">=</span>.git --exclude<span class="o">=</span><span class="se">\*</span>min.js --exclude-dir<span class="o">=</span>lib
</pre></div>
</div>
</div>
</div>



                

                
        </div></div>
        <div id="disqus_thread" class="body comments"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'esotericrubbish'; // required: replace example with your forum shortname

            // The following are highly recommended additional parameters. Remove the slashes in front to use.
            // var disqus_identifier = 'unique_dynamic_id_1234';
            // var disqus_url = 'http://example.com/permalink-to-page.html';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="related">
    <h3>Navigation</h3>
    <ul>
        <li class="right" style="margin-right: 10px">
        <a href="../genindex.html" title="General Index"
            >index</a></li>
        <li class="right" >
        <a href="index.html" title="2013"
            >previous</a> |</li>
        <li><a href="../index.html">Esoteric Rubbish</a> &raquo;</li>
        <li><a href="index.html" >2013</a> &raquo;</li>
    </ul>
</div>
            <div class="footer">
                &copy; <a href="http://google.com/profiles/whiteinge" rel="me">Copyright 2013, Seth House</a>.

                <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/us/">Some rights reserved</a>.
                Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
            </div>

            <script type="text/javascript">
                var _gaq = _gaq || [];
                _gaq.push(['_setAccount', 'UA-12716924-1']);
                _gaq.push(['_trackPageview']);

                (function() {
                    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();
            </script>
    </body>
</html>